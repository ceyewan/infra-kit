# Coord模块测试驱动开发计划

## 项目概述
基于代码审计结果，采用测试驱动开发(TDD)方式完善coord模块的测试覆盖率和修复高优先级问题。

## 测试环境
- etcd集群运行在 localhost:2379,12379,22379
- Go版本 >= 1.21
- 需要安装的依赖：go-etcd, testify

## 任务清单

### 阶段1：核心测试编写 (高优先级)

#### 1.1 Coordinator核心组件测试
- [x] 创建coordinator_test.go
- [ ] 测试New()函数的各种场景
- [ ] 测试Close()方法的资源清理
- [ ] 测试InstanceIDAllocator的缓存机制
- [ ] 测试并发安全性

#### 1.2 分布式锁服务测试
- [ ] 创建lock_test.go
- [ ] 测试Acquire()阻塞获取
- [ ] 测试TryAcquire()非阻塞获取
- [ ] 测试TTL自动续约
- [ ] 测试并发锁竞争
- [ ] 测试锁的释放和清理

#### 1.3 服务注册发现测试
- [ ] 创建registry_test.go
- [ ] 测试服务注册和注销
- [ ] 测试服务发现功能
- [ ] 测试Watch监听机制
- [ ] 测试gRPC resolver集成
- [ ] 测试并发服务注册

#### 1.4 配置中心测试
- [ ] 创建config_test.go
- [ ] 测试配置的Get/Set操作
- [ ] 测试CAS原子操作
- [ ] 测试Watch监听配置变更
- [ ] 测试类型安全性
- [ ] 测试配置管理器

#### 1.5 etcd客户端测试
- [ ] 创建etcd_client_test.go
- [ ] 测试连接建立和关闭
- [ ] 测试重试机制
- [ ] 测试错误处理
- [ ] 测试健康检查

#### 1.6 ID分配器测试
- [ ] 创建allocator_test.go
- [ ] 测试ID分配和释放
- [ ] 测试ID重用机制
- [ ] 测试并发ID分配
- [ ] 测试租约管理

### 阶段2：问题修复 (高优先级)

#### 2.1 配置验证修复
- [ ] 为Config结构体添加Validate()方法
- [ ] 在New()函数中调用验证
- [ ] 添加配置验证测试

#### 2.2 Goroutine泄露修复
- [ ] 为allocator添加明确的停止机制
- [ ] 为watcher添加清理机制
- [ ] 添加goroutine泄露检测测试

#### 2.3 健康检查机制
- [ ] 设计HealthChecker接口
- [ ] 实现各组件的健康检查
- [ ] 添加健康检查测试

### 阶段3：集成示例 (中等优先级)

#### 3.1 完整集成示例
- [ ] 创建comprehensive_integration_test.go
- [ ] 模拟真实使用场景
- [ ] 测试组件间协作

#### 3.2 性能基准测试
- [ ] 创建benchmark测试
- [ ] 测试关键操作性能
- [ ] 性能优化建议

### 阶段4：文档和报告

#### 4.1 测试覆盖率报告
- [ ] 生成覆盖率报告
- [ ] 确保覆盖率达到80%以上

#### 4.2 文档更新
- [ ] 更新API文档
- [ ] 添加最佳实践指南

## 测试策略

### 单元测试
- 使用testify框架
- Mock外部依赖
- 测试边界条件
- 测试错误场景

### 集成测试
- 使用真实etcd集群
- 测试组件间交互
- 测试并发场景
- 测试异常恢复

### 性能测试
- 基准测试关键操作
- 内存使用分析
- 并发性能测试

## 成功标准

1. **测试覆盖率** ≥ 80%
2. **所有测试通过** 无flaky test
3. **无内存泄露** 通过goroutine泄露检测
4. **性能指标** 符合预期
5. **文档完整** API文档和示例齐全

## 工具和依赖

### 测试框架
- github.com/stretchr/testify
- github.com/golang/mock

### 性能分析
- go test -bench=. -benchmem
- go test -coverprofile=coverage.out

### 代码质量
- golangci-lint
- go vet

## 风险和缓解措施

### 风险1：etcd依赖
- **风险**：测试依赖外部etcd服务
- **缓解**：使用TestMain启动测试etcd，提供fallback机制

### 风险2：并发测试
- **风险**：并发测试可能不稳定
- **缓解**：使用sync.WaitGroup和context控制测试时序

### 风险3：资源清理
- **风险**：测试后资源清理不彻底
- **缓解**：使用defer和teardown函数确保清理

## 时间估算

- **阶段1**：2-3天（核心测试）
- **阶段2**：1-2天（问题修复）
- **阶段3**：1天（集成示例）
- **阶段4**：0.5天（文档报告）

**总计**：4.5-6.5天

## 输出物

1. 完整的测试套件
2. 测试覆盖率报告
3. 性能基准测试结果
4. 修复后的代码
5. 更新的文档
6. 最佳实践指南