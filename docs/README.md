# Go 微服务基础设施组件库设计规范

## 1. 设计哲学

`infra-kit` 是一个专注于构建高质量、可复用的 Go 微服务基础设施组件库。本规范旨在确保所有组件在架构上的一致性、可维护性和生产级可靠性。

> **寻找用法？** 请直接阅读 -> **[快速上手指南](./usage_guide.md)**

---

## 2. 组件设计模式

### 2.1 Provider 模式与构造函数

所有有状态、有配置或有外部依赖的组件，都必须通过 `Provider` 模式暴露其能力。

**标准构造函数签名**:
```go
func New(ctx context.Context, config *Config, opts ...Option) (Provider, error)
```

**职责分离**:
- `config`: 组件的核心静态配置
- `opts ...Option`: 外部依赖注入（如 `clog.Logger`, `coord.Provider`）

**例外**: 纯工具包可直接提供包级函数。

### 2.2 默认配置 (`GetDefaultConfig`)

**标准签名**:
```go
func GetDefaultConfig(env string) *Config
```

**环境支持**:
- `"development"`: 开发环境默认配置
- `"production"`: 生产环境优化配置

### 2.3 接口设计原则

**上下文优先**: 所有 I/O 操作必须接受 `context.Context` 作为首参数
**最小化接口**: 只暴露核心功能，避免内部实现细节泄露
**类型安全**: 使用强类型和明确的错误处理

---

## 3. 配置管理模式

### 3.1 声明式配置

- 可变配置通过配置中心管理，组件不提供命令式修改 API
- 配置变更通过监听机制自动更新内部状态
- 故障隔离：配置变更失败不影响组件正常运行

### 3.2 组件自治的动态配置

**实现模式**:
```go
// 在 New 函数中监听配置变更
watcher, _ := coordProvider.Config().WatchPrefix(ctx, "/config/component/", &config)
go func() {
    for range watcher.Changes() {
        // 线程安全地更新内部状态
        component.updateConfig(config)
    }
}()
```

---

## 4. 组件模块化设计

### 4.1 独立 Go 模块

每个组件都应该是一个独立的 Go 模块：

```
go-kit/
├── clog/          # module my-org/go-kit/clog
│   ├── clog.go
│   ├── clog_test.go
│   └── go.mod
├── cache/         # module my-org/go-kit/cache
│   ├── cache.go
│   ├── redis.go
│   └── go.mod
├── once/          # module my-org/go-kit/once
│   ├── once.go
│   └── go.mod
└── uid/           # module my-org/go-kit/uid
    ├── snowflake.go
    └── go.mod
```

### 4.2 模块初始化

**在每个组件目录中执行**:
```bash
cd component-name
go mod init my-org/go-kit/component-name
```

### 4.3 依赖管理

- **最小依赖**: 只依赖必要的第三方库
- **版本控制**: 使用语义化版本
- **兼容性**: 保持向后兼容性

---

## 5. 组件层次与依赖

### 5.1 依赖层次

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Your Services)                     │
└─────────────────────────┬───────────────────────────────────┘
                         │
              ┌──────────▼───────────┐
              │    可观测性层         │
              │  • metrics           │
              └───────────────────────┘
                         │
┌─────────────────────────┼───────────────────────────────────┐
│                    服务治理层                               │
│  • ratelimit  • once  • breaker  • es                      │
└─────────────────────────┼───────────────────────────────────┘
                         │
              ┌──────────▼───────────┐
              │    核心基础设施层     │
              │  • coord  • cache   │
              │  • db     • mq      │
└─────────────┬───────────────────────┘
              │
      ┌───────▼───────┐
      │   基础设施层   │
      │ • clog • uid  │
      └───────────────┘
```

### 5.2 实现阶段

**阶段 0 - 基础组件**:
- `clog` - 结构化日志（无依赖）
- `uid` - 唯一 ID 生成（无依赖）

**阶段 1 - 核心基础设施**:
- `coord` - 分布式协调（依赖 clog）
- `cache` - 分布式缓存（依赖 clog）
- `db` - 数据库访问（依赖 clog）
- `mq` - 消息队列（依赖 clog）

**阶段 2 - 服务治理**:
- `ratelimit` - 分布式限流（依赖 clog, coord, cache）
- `once` - 分布式幂等（依赖 clog, cache）
- `breaker` - 熔断器（依赖 clog, coord）
- `es` - 搜索引擎（依赖 clog）

**阶段 3 - 可观测性**:
- `metrics` - 监控指标（依赖 clog）

---

## 6. 组件文档规范

### 6.1 文档结构

每个组件文档必须包含：

1. **设计理念** - 组件解决的问题和核心价值
2. **核心 API 契约** - 公开接口和设计原则
3. **标准用法** - 常见使用场景和代码示例
4. **最佳实践** - 推荐的使用模式和注意事项
5. **性能考虑** - 性能特征和优化建议

### 6.2 代码示例标准

**必须包含**:
- 基本初始化
- 常见使用场景
- 错误处理
- 配置示例
- 测试用例

---

## 7. 组件文档索引

### 核心基础设施组件

- **[结构化日志 (clog)](./clog.md)** - 高性能、上下文感知的日志组件
- **[唯一 ID 生成 (uid)](./uid.md)** - 分布式唯一 ID 生成器
- **[分布式协调 (coord)](./coord.md)** - 服务发现、配置中心、分布式锁
- **[分布式缓存 (cache)](./cache.md)** - 高性能缓存和分布式锁
- **[数据库访问 (db)](./db.md)** - 基于 GORM 的数据库访问层
- **[消息队列 (mq)](./mq.md)** - 异步消息处理组件

### 服务治理组件

- **[分布式限流 (ratelimit)](./ratelimit.md)** - 令牌桶算法限流组件
- **[分布式幂等 (once)](./once.md)** - 操作幂等性保证
- **[熔断器 (breaker)](./breaker.md)** - 服务保护机制
- **[搜索引擎 (es)](./es.md)** - 全文搜索和数据分析

### 可观测性组件

- **[监控指标 (metrics)](./metrics.md)** - 系统监控和链路追踪

### 使用指南

- **[快速上手指南](./usage_guide.md)** - 完整的使用示例和最佳实践

---

## 8. 开发指南

### 8.1 新组件开发流程

1. **设计阶段**
   - 明确组件职责和边界
   - 定义核心接口和 API
   - 设计配置结构

2. **实现阶段**
   - 遵循 Provider 模式
   - 实现标准构造函数
   - 添加完整测试

3. **文档阶段**
   - 编写组件文档
   - 提供使用示例
   - 说明最佳实践

4. **发布阶段**
   - 版本管理
   - 变更日志
   - 兼容性检查

### 8.2 代码质量要求

- **测试覆盖率**: ≥ 80%
- **代码风格**: 遵循 Go 官方标准
- **性能测试**: 提供基准测试
- **文档完整**: 所有公共 API 必须有文档

### 8.3 发布流程

1. 语义化版本管理
2. 变更日志维护
3. 兼容性保证
4. 自动化测试和发布

---

## 9. 最佳实践

### 9.1 组件选择指南

- **简单应用**: `clog` + `cache` + `db`
- **微服务集群**: 增加 `coord` + `mq` + `ratelimit`
- **高可靠性要求**: 增加 `once` + `breaker` + `metrics`
- **搜索需求**: 增加 `es`

### 9.2 配置管理策略

1. **开发环境**: 使用 `GetDefaultConfig("development")`
2. **生产环境**: 使用 `GetDefaultConfig("production")` 并覆盖关键配置
3. **动态配置**: 通过配置中心管理运行时配置

### 9.3 错误处理最佳实践

- 网络异常：组件内置重试机制
- 配置错误：启动时快速失败
- 业务异常：提供明确的错误类型

---

*遵循这些规范可以确保组件库的一致性、可维护性和生产级可靠性。*
